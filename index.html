<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Join & Save – Owner</title>
  <style>
    /* Animated background */
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 20px;
      display: flex; justify-content: center; align-items: flex-start;
      min-height: 100vh;
      background: linear-gradient(-45deg, #ff9a9e, #fad0c4, #fbc2eb, #a1c4fd);
      background-size: 400% 400%;
      animation: gradientBG 12s ease infinite;
    }
    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .container {
      width: 100%;
      max-width: 480px;
      background: #fff;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.2);
    }
    h2 { text-align: center; font-size: 24px; margin-bottom: 20px; }
    label { font-weight: bold; display: block; margin-top: 10px; }
    input, select {
      width: 100%; padding: 12px; margin-top: 6px;
      border: 1px solid #ccc; border-radius: 8px; font-size: 16px;
    }
    button {
      width: 100%; padding: 14px; margin-top: 16px;
      font-size: 18px; border: none; border-radius: 8px;
      background: #28a745; color: white; font-weight: bold;
      cursor: pointer;
    }
    button:disabled { background: #aaa; }
    .link-box { margin-top: 15px; padding: 10px; background: #f1f1f1; border-radius: 8px; word-wrap: break-word; }
    .banner {
      margin-top: 15px; padding: 12px; border-radius: 8px;
      color: white; font-weight: bold; text-align: center;
    }
    .expired { background: #dc3545; }
    .contacts { margin-top: 20px; }
    .contacts ul { padding-left: 20px; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Owner – Create Session</h2>
    <label>Duration:</label>
    <input type="number" id="durationValue" placeholder="Enter duration">
    <select id="durationUnit">
      <option value="minutes">Minutes</option>
      <option value="hours">Hours</option>
      <option value="days">Days</option>
    </select>

    <label>WhatsApp Group Link:</label>
    <input type="text" id="groupLink" placeholder="https://chat.whatsapp.com/...">
    <button onclick="createSession()">Create Session</button>

    <div id="shareLink" class="link-box" style="display:none;"></div>
    <div id="banner"></div>

    <div class="contacts" id="contactsBox" style="display:none;">
      <h3>Contacts</h3>
      <ul id="contactsList"></ul>
      <button onclick="downloadVCF()">⬇️ Download Contacts</button>
    </div>
  </div>

<script>
const API_KEY = "$2a$10$lnxPgBn17zOR3IDXA0JLTu8kBwjfTzQWfFnRxg5Q.B8pAew9/.xgC"; 
let binId = null, sessionData = null;

function convertDuration(value, unit) {
  if (unit === "minutes") return value * 60 * 1000;
  if (unit === "hours") return value * 60 * 60 * 1000;
  if (unit === "days") return value * 24 * 60 * 60 * 1000;
  return value;
}

async function createSession() {
  const val = parseInt(document.getElementById("durationValue").value);
  const unit = document.getElementById("durationUnit").value;
  const groupLink = document.getElementById("groupLink").value.trim();

  if (!val || !groupLink) {
    alert("Please enter both duration and group link.");
    return;
  }

  const duration = convertDuration(val, unit);

  sessionData = {
    createdAt: Date.now(),
    duration: duration,
    groupLink: groupLink,
    contacts: []
  };

  try {
    const res = await fetch("https://api.jsonbin.io/v3/b", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-Master-Key": API_KEY
      },
      body: JSON.stringify(sessionData)
    });

    console.log("Status:", res.status);
    const txt = await res.text();
    console.log("Response:", txt);

    if (!res.ok) {
      alert("Error creating session: " + res.status);
      return;
    }

    const data = JSON.parse(txt);
    binId = data.metadata.id;

    document.getElementById("shareLink").style.display = "block";
    document.getElementById("shareLink").innerHTML =
      "Share this link with others:<br><b>" +
      window.location.origin + "/join.html?session=" + binId + "</b>";

    pollContacts();
  } catch (err) {
    console.error("Fetch error:", err);
    alert("Network or server error. Check console for details.");
  }
}

async function pollContacts() {
  if (!binId) return;
  try {
    const res = await fetch(`https://api.jsonbin.io/v3/bins/${binId}/latest`, {
      headers: { "X-Master-Key": API_KEY }
    });
    const data = await res.json();
    sessionData = data.record;

    const now = Date.now();
    const expired = now > sessionData.createdAt + sessionData.duration;
    const banner = document.getElementById("banner");

    if (expired) {
      banner.innerHTML = "⚠️ This session has ended. Download contacts now.";
      banner.className = "banner expired";
    } else {
      banner.innerHTML = "";
      banner.className = "";
    }

    const contactsBox = document.getElementById("contactsBox");
    const list = document.getElementById("contactsList");
    list.innerHTML = "";
    sessionData.contacts.forEach(c => {
      const li = document.createElement("li");
      li.textContent = `${c.name} – ${c.number}`;
      list.appendChild(li);
    });
    contactsBox.style.display = "block";
  } catch (err) {
    console.error("Poll error:", err);
  }

  setTimeout(pollContacts, 5000);
}

function downloadVCF() {
  if (!sessionData || !sessionData.contacts) return;
  let vcf = "";
  sessionData.contacts.forEach(c => {
    vcf += `BEGIN:VCARD\nVERSION:3.0\nFN:${c.name}\nTEL:${c.number}\nEND:VCARD\n`;
  });
  const blob = new Blob([vcf], { type: "text/vcard" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "contacts.vcf";
  a.click();
}
</script>
</body>
</html>
